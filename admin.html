<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Chat Panel</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #1a1a2e;
            --sidebar-color: #16213e;
            --chat-bg: #0f3460;
            --primary-color: #e94560;
            --accent-color: #53a8b6;
            --text-color: #e0e0e0;
            --input-bg: #2a2a4e;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            height: 100vh;
            overflow: hidden;
            opacity: 0;
            animation: fadeIn 0.5s forwards;
        }

        @keyframes fadeIn {
            to { opacity: 1; }
        }

        .admin-panel {
            display: flex;
            width: 100%;
            height: 100%;
        }

        #user-sidebar {
            width: 300px;
            background-color: var(--sidebar-color);
            border-right: 2px solid var(--chat-bg);
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        #user-sidebar h2 {
            border-bottom: 2px solid var(--accent-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        #user-list {
            list-style-type: none;
            overflow-y: auto;
        }

        #user-list li {
            padding: 15px;
            margin-bottom: 10px;
            background-color: var(--input-bg);
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            position: relative;
            padding-left: 30px;
            animation: slideInFromLeft 0.5s ease-out forwards;
        }
        
        @keyframes slideInFromLeft {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        #user-list li:before {
            content: '';
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 10px;
            height: 10px;
            background-color: #28a745;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
        }

        #user-list li.active, #user-list li:hover {
            background-color: var(--accent-color);
            color: var(--bg-color);
            transform: scale(1.02);
        }

        .chat-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            background: linear-gradient(135deg, var(--bg-color) 0%, var(--chat-bg) 100%);
        }

        #chat-header {
            padding: 20px;
            background-color: var(--sidebar-color);
            border-bottom: 2px solid var(--chat-bg);
            text-align: center;
        }

        #chat-header h3 {
            font-size: 1.2em;
        }
        
        #no-user-selected {
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            color: #777;
        }

        #chat-window {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            display: none; /* Initially hidden */
        }
        
        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 70%;
            opacity: 0;
            transform: translateY(20px);
            animation: popIn 0.3s forwards;
        }
        
        @keyframes popIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.sent {
            background-color: var(--accent-color);
            color: var(--bg-color);
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }

        .message.received {
            background-color: var(--input-bg);
            margin-right: auto;
            border-bottom-left-radius: 4px;
        }

        #chat-form {
            display: none; /* Initially hidden */
            padding: 20px;
            background-color: var(--sidebar-color);
            align-items: center;
            gap: 10px;
        }

        #chat-form input {
            flex-grow: 1;
            padding: 15px;
            border: none;
            border-radius: 8px;
            background-color: var(--input-bg);
            color: var(--text-color);
            font-size: 1em;
        }

        #chat-form input:focus {
            outline: none;
            box-shadow: 0 0 15px var(--accent-color);
        }

        #chat-form button {
            padding: 12px 16px;
            border: none;
            border-radius: 8px;
            background-color: var(--accent-color);
            color: var(--bg-color);
            cursor: pointer;
        }
    </style>
</head>
<body>

    <div class="admin-panel">
        <aside id="user-sidebar">
            <h2>Connected Users</h2>
            <ul id="user-list">
                <!-- Users will be dynamically added here -->
            </ul>
        </aside>

        <main class="chat-container">
            <div id="chat-header">
                <h3 id="current-chat-user">Select a user to start chatting</h3>
            </div>
            <div id="no-user-selected">
                <p>Waiting for users to connect...</p>
            </div>
            <div id="chat-window">
                <!-- Messages will be appended here -->
            </div>
            <form id="chat-form">
                <input type="text" id="message-input" placeholder="Type your message..." autocomplete="off">
                <button type="button" id="emoji-button">ðŸ˜Š</button>
                <button type="button" id="file-button">ðŸ“Ž</button>
                <button type="submit" id="send-button">Send</button>
                <input type="file" id="file-input" style="display:none" />
            </form>
        </main>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/emoji-button@latest/dist/index.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const WEBSOCKET_URL = 'wss://chat-i8zf.onrender.com/live-chat';

            const userList = document.getElementById('user-list');
            const chatWindow = document.getElementById('chat-window');
            const messageInput = document.getElementById('message-input');
            const chatForm = document.getElementById('chat-form');
            const currentChatUserHeader = document.getElementById('current-chat-user');
            const noUserSelectedView = document.getElementById('no-user-selected');
            const fileInput = document.getElementById('file-input');
            const emojiButton = document.getElementById('emoji-button');
            const fileButton = document.getElementById('file-button');

            const picker = new EmojiButton();
            emojiButton.addEventListener('click', () => picker.togglePicker(emojiButton));
            picker.on('emoji', emoji => {
                messageInput.value += emoji;
                messageInput.focus();
            });

            fileButton.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', () => {
                const file = fileInput.files[0];
                if (file && selectedUserId) {
                    sendFile(file);
                }
                fileInput.value = '';
            });

            messageInput.addEventListener('paste', (e) => {
                const items = e.clipboardData.items;
                for (const item of items) {
                    if (item.kind === 'file') {
                        const file = item.getAsFile();
                        if (file && selectedUserId) {
                            sendFile(file);
                        }
                        e.preventDefault();
                    }
                }
            });

            let socket;
            let reconnectDelay = 1000;
            let selectedUserId = null;
            let chats = {};

            function connect() {
                socket = new WebSocket(WEBSOCKET_URL);

                socket.onopen = () => {
                    reconnectDelay = 1000;
                    socket.send(JSON.stringify({ type: 'admin-init' }));
                    startHeartbeat();
                };

                socket.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    switch (data.type) {
                        case 'user-connected':
                            addUserToList(data.id, data.name, data.ip);
                            break;
                        case 'user-disconnected':
                            removeUserFromList(data.id);
                            break;
                        case 'user-renamed':
                            renameUser(data.id, data.name);
                            break;
                        case 'message':
                            handleIncomingMessage(data);
                            break;
                        case 'file':
                            handleIncomingFile(data);
                            break;
                        case 'all-users':
                            data.users.forEach(u => addUserToList(u.id, u.name, u.ip));
                            break;
                        case 'pong':
                            break;
                    }
                };

                socket.onclose = () => {
                    stopHeartbeat();
                    setTimeout(connect, reconnectDelay);
                    reconnectDelay = Math.min(reconnectDelay * 2, 30000);
                };

                socket.onerror = () => {
                    socket.close();
                };
            }

            connect();

            let heartbeatInterval;
            function startHeartbeat() {
                heartbeatInterval = setInterval(() => {
                    if (socket.readyState === WebSocket.OPEN) {
                        socket.send(JSON.stringify({ type: 'ping' }));
                    }
                }, 30000);
            }

            function stopHeartbeat() {
                clearInterval(heartbeatInterval);
            }

            chatForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const messageText = messageInput.value.trim();
                if (messageText && selectedUserId && socket.readyState === WebSocket.OPEN) {
                    socket.send(JSON.stringify({ type: 'message', to: selectedUserId, text: messageText }));
                    addMessageToChat(selectedUserId, 'sent', linkify(messageText));
                    messageInput.value = '';
                }
            });

            function sendFile(file) {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    socket.send(JSON.stringify({
                        type: 'file',
                        to: selectedUserId,
                        name: file.name,
                        mime: file.type,
                        data: base64
                    }));
                    addFileMessage(selectedUserId, 'sent', file.name, file.type, base64);
                };
                reader.readAsDataURL(file);
            }

            function addUserToList(id, name, ip) {
                if (document.getElementById(`user-${id}`)) return;
                const userItem = document.createElement('li');
                userItem.id = `user-${id}`;
                userItem.dataset.userId = id;
                userItem.dataset.ip = ip;
                userItem.textContent = `${name} (${ip})`;
                userItem.addEventListener('click', () => selectUser(id));
                userList.appendChild(userItem);
                chats[id] = chats[id] || [];
            }

            function removeUserFromList(id) {
                const userItem = document.getElementById(`user-${id}`);
                if (userItem) userItem.remove();
                delete chats[id];
                if (selectedUserId === id) {
                    selectedUserId = null;
                    chatWindow.innerHTML = '';
                    chatWindow.style.display = 'none';
                    chatForm.style.display = 'none';
                    noUserSelectedView.style.display = 'flex';
                    currentChatUserHeader.textContent = 'Select a user to start chatting';
                }
            }

            function renameUser(id, name) {
                const userItem = document.getElementById(`user-${id}`);
                if (userItem) {
                    userItem.textContent = `${name} (${userItem.dataset.ip})`;
                }
            }

            function selectUser(id) {
                if (selectedUserId) {
                    document.getElementById(`user-${selectedUserId}`)?.classList.remove('active');
                }
                selectedUserId = id;
                document.getElementById(`user-${id}`).classList.add('active');
                currentChatUserHeader.textContent = `Chatting with ${document.getElementById(`user-${id}`).textContent}`;
                noUserSelectedView.style.display = 'none';
                chatWindow.style.display = 'block';
                chatForm.style.display = 'flex';
                loadChatHistory(id);
            }

            function loadChatHistory(id) {
                chatWindow.innerHTML = '';
                (chats[id] || []).forEach(msg => {
                    if (msg.type === 'file') {
                        appendFileMessage(msg.direction, msg.name, msg.mime, msg.data);
                    } else {
                        appendMessage(msg.direction, msg.html);
                    }
                });
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }

            function handleIncomingMessage(message) {
                const fromUserId = message.from;
                addMessageToChat(fromUserId, 'received', linkify(message.text));
            }

            function handleIncomingFile(message) {
                const fromUserId = message.from;
                addFileMessage(fromUserId, 'received', message.name, message.mime, message.data);
            }

            function addMessageToChat(userId, direction, html) {
                chats[userId] = chats[userId] || [];
                chats[userId].push({ direction, html });

                if (userId === selectedUserId) {
                    appendMessage(direction, html);
                } else {
                    const userItem = document.getElementById(`user-${userId}`);
                    if (userItem && !userItem.querySelector('.notification-dot')) {
                        const dot = document.createElement('span');
                        dot.className = 'notification-dot';
                        userItem.appendChild(dot);
                    }
                }
            }

            function addFileMessage(userId, direction, name, mime, data) {
                chats[userId] = chats[userId] || [];
                chats[userId].push({ type: 'file', direction, name, mime, data });
                if (userId === selectedUserId) {
                    appendFileMessage(direction, name, mime, data);
                }
            }

            function appendMessage(direction, html) {
                const messageElement = document.createElement('div');
                messageElement.classList.add('message', direction);
                messageElement.innerHTML = html;
                chatWindow.appendChild(messageElement);
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }

            function appendFileMessage(direction, name, mime, data) {
                const blob = b64toBlob(data, mime);
                const url = URL.createObjectURL(blob);
                let html;
                if (mime.startsWith('image/')) {
                    html = `<img src="${url}" alt="${name}" style="max-width:100%;">`;
                } else {
                    html = `<a href="${url}" download="${name}" target="_blank">${name}</a>`;
                }
                appendMessage(direction, html);
            }

            function linkify(text) {
                return text.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>');
            }

            function b64toBlob(base64, mime) {
                const byteChars = atob(base64);
                const byteNumbers = new Array(byteChars.length);
                for (let i = 0; i < byteChars.length; i++) {
                    byteNumbers[i] = byteChars.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                return new Blob([byteArray], { type: mime });
            }
        });
    </script>
</body>
</html>